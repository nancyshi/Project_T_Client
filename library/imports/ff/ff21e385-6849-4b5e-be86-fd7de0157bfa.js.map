{"version":3,"sources":["../../../../../../assets/scripts/towerDefens/towers/assets/scripts/towerDefens/towers/towerMgr.js"],"names":["cc","Class","extends","Component","properties","skills","commonSkillId","commonSkillConfig","commonSkillCd","isUIShowed","currentUI","towerUIPrefab","Prefab","canAttack","get","_canAttack","set","value","attackTimer","_attackTimer","gameMgr","releasingSkill","onLoad","node","getChildByName","on","onTouchEnd","find","getComponent","start","stringSkillId","isCommonSkill","parseInt","toString","cd","update","dt","tryToReleaseCommonSkill","event","showTowerUI","stopPropagation","onDestroy","off","ui","instantiate","scale","x","y","addChild","tween","to","removeTowerUI","self","call","removeFromParent","config","require","faction","targetNum","attackRange","targets","possibleTargets","alivedMonstors","towers","index","element","dis","v2","mag","push","currentNum","length","releaseSkill","skillId","Skill","skillObj","id","owner","ownerMgr","getTargetsInHurtRange","givenTarget","hurtRange","results","sendBullet"],"mappings":"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","file":"towerMgr.js","sourceRoot":"../../../../../../assets/scripts/towerDefens/towers","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] https://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        skills: null,\n        commonSkillId: null,\n        commonSkillConfig: null,\n        commonSkillCd: null,\n        isUIShowed: false,\n        currentUI: null,\n        towerUIPrefab: cc.Prefab,\n\n        canAttack: {\n            get() {\n                return this._canAttack\n            },\n            set(value) {\n                this._canAttack = value\n            }\n        },\n        attackTimer: {\n            get() {\n                return this._attackTimer\n            },\n            set(value) {\n                this._attackTimer = value\n                if (value >= this.commonSkillCd) {\n                    this.canAttack = true\n                    this.attackTimer = null\n                }\n            }\n        },\n\n        gameMgr: null,\n        releasingSkill: null\n    },\n\n    // LIFE-CYCLE CALLBACKS:\n\n    onLoad () {\n        this.node.getChildByName(\"touchNode\").on(\"touchend\",this.onTouchEnd,this)\n        this.gameMgr = cc.find(\"Canvas/gameMgrNode\").getComponent(\"gameMgr\")\n    },\n\n    start () {\n        for (var stringSkillId in this.skills) {\n            var isCommonSkill = this.skills[stringSkillId].isCommonSkill\n            if (isCommonSkill == true) {\n                this.commonSkillId = parseInt(stringSkillId)\n                break\n            }\n        }\n\n        if (this.commonSkillId != null) {\n            this.canAttack = true\n            this.commonSkillCd = this.skills[this.commonSkillId.toString()].cd\n        }\n    },\n\n    update (dt) {\n        if (this.attackTimer != null) {\n            this.attackTimer += dt\n        }\n\n        if (this.canAttack == true) {\n            this.tryToReleaseCommonSkill()\n        }\n    },\n    onTouchEnd(event) {\n        if (this.isUIShowed == false) {\n            this.showTowerUI()\n        }\n        event.stopPropagation()\n    },\n\n    onDestroy() {\n        this.node.getChildByName(\"touchNode\").off(\"touchend\",this.onTouchEnd,this)\n    },\n\n    showTowerUI(){\n        var ui = cc.instantiate(this.towerUIPrefab)\n        this.currentUI = ui\n        ui.scale = 0\n        ui.x = 0\n        ui.y = 26.333\n        this.isUIShowed = true\n        this.node.addChild(ui)\n        cc.tween(ui)\n            .to(0.2,{scale: 1.2})\n            .start()\n    },\n\n    removeTowerUI() {\n        if (this.isUIShowed == true) {\n            var self = this\n            cc.tween(this.currentUI)\n                .to(0.2,{scale: 0})\n                .call(function(){\n                    self.currentUI.removeFromParent()\n                    self.currentUI = null\n                    self.isUIShowed = false\n                })\n                .start()\n        }\n    },\n\n    tryToReleaseCommonSkill() {\n        var config = require(\"skillConfig\")[this.commonSkillId.toString()]\n        var faction = config.faction\n        var targetNum = config.targetNum\n        var attackRange = config.attackRange\n        var targets = []\n\n        var possibleTargets = null\n        switch(faction) {\n            case 1:\n                possibleTargets = this.gameMgr.alivedMonstors\n                break\n            case 2:\n                possibleTargets = this.gameMgr.towers\n                break\n        }\n        \n        if (targetNum == -1) {\n            for (var index in possibleTargets) {\n                var element = possibleTargets[index]\n                var dis = cc.v2(element.x - this.node.x, element.y - this.node.y).mag()\n                if (dis <= attackRange) {\n                    targets.push(element)\n                }\n            }\n        }\n        else {\n            var currentNum = 0\n            for (var index in possibleTargets) {\n                var element = possibleTargets[index]\n                var dis = cc.v2(element.x - this.node.x, element.y - this.node.y).mag()\n                if (dis <= attackRange) {\n                    targets.push(element)\n                    currentNum += 1\n                    if (currentNum == targetNum) {\n                        break\n                    }\n                }\n            }\n        }\n\n        if (targets.length > 0) {\n            this.releaseSkill(this.commonSkillId,targets)\n            this.canAttack = false\n            this.attackTimer = 0\n        }\n    },\n\n    releaseSkill(skillId,targets) {   \n        var Skill = require(\"skill\")\n        var skillObj = new Skill()\n        skillObj.id = skillId\n        skillObj.targets = targets\n        skillObj.owner = this.node\n        skillObj.ownerMgr = this\n        this.releasingSkill = skillObj\n        skillObj.releaseSkill()\n    },\n\n    getTargetsInHurtRange(givenTarget,hurtRange,faction) {\n        if (hurtRange == -1) {\n            return [givenTarget]\n        }\n\n        var possibleTargets = null\n        switch(faction) {\n            case 1:\n                possibleTargets = this.gameMgr.alivedMonstors\n                break\n            case 2:\n                possibleTargets = this.gameMgr.towers\n                break\n        }\n\n        var results = []\n        for(var index in possibleTargets) {\n            var element = possibleTargets[index]\n            var dis = cc.v2(element.x - givenTarget.x, element.y - givenTarget.y).mag()\n            if (dis <= hurtRange) {\n                results.push(element)\n            }\n        }\n        return results\n    },\n\n    sendBullet() {\n        this.releasingSkill.sendBullet()\n    }\n});\n"]}