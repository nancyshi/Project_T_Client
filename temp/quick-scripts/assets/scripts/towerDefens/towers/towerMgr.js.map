{"version":3,"sources":["towerMgr.js"],"names":["cc","Class","extends","Component","properties","hurt","hurtDelta","hurtRange","attackRange","hurtType","monstors","canAttack","get","_canAttack","set","value","self","scheduleOnce","bulletEffectPrefab","Prefab","hurtEffectPrefab","bulletEffectOffset","v2","currentEffect","isUIShowed","currentUI","towerUIPrefab","onLoad","node","getChildByName","on","onTouchEnd","start","find","getComponent","alivedMonstors","update","dt","length","index","oneMonstor","dis","x","y","mag","attackOneMonstor","effect","instantiate","effectMgr","effectType","target","delegate","animate","Animation","play","playEffect","addChild","_acturalHurt","monstor","monstorMgr","getHurt","monstorsForHurt","push","event","showTowerUI","stopPropagation","onDestroy","off","ui","scale","tween","to","removeTowerUI","call","removeFromParent"],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEAA,GAAGC,KAAH,CAAS;AACLC,aAASF,GAAGG,SADP;;AAGLC,gBAAY;AACRC,cAAM,EADE;AAERC,mBAAW,CAFH,EAEM;AACdC,mBAAW,CAAC,CAHJ,EAGO;AACfC,qBAAa,IAJL;AAKRC,kBAAU,CALF,EAKK;AACbC,kBAAU,IANF;AAORC,mBAAW;AACPC,eADO,iBACD;AACF,oBAAI,KAAKC,UAAL,IAAmB,IAAvB,EAA6B;AACzB,yBAAKA,UAAL,GAAkB,IAAlB;AACH;AACD,uBAAO,KAAKA,UAAZ;AACH,aANM;AAOPC,eAPO,eAOHC,KAPG,EAOI;AACP,qBAAKF,UAAL,GAAkBE,KAAlB;AACA,oBAAIA,SAAS,KAAb,EAAoB;AAChB,wBAAIC,OAAO,IAAX;AACA,yBAAKC,YAAL,CAAkB,YAAU;AACxBD,6BAAKH,UAAL,GAAkB,IAAlB;AACH,qBAFD,EAEE,KAAKP,SAFP;AAGH;AACJ;AAfM,SAPH;AAwBRY,4BAAoBlB,GAAGmB,MAxBf;AAyBRC,0BAAkBpB,GAAGmB,MAzBb;AA0BRE,4BAAoBrB,GAAGsB,EAAH,CAAM,CAAN,EAAQ,CAAR,CA1BZ;AA2BRC,uBAAe,IA3BP;AA4BRC,oBAAY,KA5BJ;AA6BRC,mBAAW,IA7BH;AA8BRC,uBAAe1B,GAAGmB;AA9BV,KAHP;;AAoCL;;AAEAQ,UAtCK,oBAsCK;AACN,aAAKC,IAAL,CAAUC,cAAV,CAAyB,WAAzB,EAAsCC,EAAtC,CAAyC,UAAzC,EAAoD,KAAKC,UAAzD,EAAoE,IAApE;AACH,KAxCI;AA0CLC,SA1CK,mBA0CI;AACL,aAAKtB,QAAL,GAAgBV,GAAGiC,IAAH,CAAQ,oBAAR,EAA8BC,YAA9B,CAA2C,SAA3C,EAAsDC,cAAtE;AACH,KA5CI;AA8CLC,UA9CK,kBA8CGC,EA9CH,EA8CO;AACR,YAAI,KAAK1B,SAAL,IAAkB,IAAlB,IAA0B,KAAKD,QAAL,CAAc4B,MAAd,GAAuB,CAArD,EAAwD;AACpD,iBAAK,IAAIC,KAAT,IAAkB,KAAK7B,QAAvB,EAAiC;AAC7B,oBAAI8B,aAAa,KAAK9B,QAAL,CAAc6B,KAAd,CAAjB;AACA,oBAAIE,MAAMzC,GAAGsB,EAAH,CAAMkB,WAAWE,CAAX,GAAe,KAAKd,IAAL,CAAUc,CAA/B,EAAkCF,WAAWG,CAAX,GAAe,KAAKf,IAAL,CAAUe,CAA3D,EAA8DC,GAA9D,EAAV;AACA,oBAAIH,OAAO,KAAKjC,WAAhB,EAA6B;AACzB,yBAAKqC,gBAAL,CAAsBL,UAAtB;AACA;AACH;AACJ;AACJ;AACJ,KAzDI;AA2DLK,oBA3DK,4BA2DYL,UA3DZ,EA2DwB;AACzB,aAAK7B,SAAL,GAAiB,KAAjB;AACA,YAAI,KAAKO,kBAAL,IAA2B,IAA/B,EAAqC;AACjC,gBAAI4B,SAAS9C,GAAG+C,WAAH,CAAe,KAAK7B,kBAApB,CAAb;AACA4B,mBAAOJ,CAAP,GAAW,KAAKd,IAAL,CAAUc,CAAV,GAAc,KAAKrB,kBAAL,CAAwBqB,CAAjD;AACAI,mBAAOH,CAAP,GAAW,KAAKf,IAAL,CAAUe,CAAV,GAAc,KAAKtB,kBAAL,CAAwBsB,CAAjD;AACA,gBAAIK,YAAYF,OAAOZ,YAAP,CAAoB,WAApB,CAAhB;AACAc,sBAAUC,UAAV,GAAuB,CAAvB;AACA,gBAAI,KAAK7B,gBAAL,IAAyB,IAA7B,EAAmC;AAC/B4B,0BAAU5B,gBAAV,GAA6B,KAAKA,gBAAlC;AACH;AACD4B,sBAAUE,MAAV,GAAmBV,UAAnB;AACAQ,sBAAUG,QAAV,GAAqB,IAArB;AACA,iBAAK5B,aAAL,GAAqBuB,MAArB;AACH,SAZD,MAaK;AACD,gBAAI,KAAK1B,gBAAL,IAAyB,IAA7B,EAAmC;AAC/B,oBAAI0B,SAAS9C,GAAG+C,WAAH,CAAe,KAAK3B,gBAApB,CAAb;AACA,oBAAI4B,YAAYF,OAAOZ,YAAP,CAAoB,WAApB,CAAhB;AACAc,0BAAUC,UAAV,GAAuB,CAAvB;AACAD,0BAAUG,QAAV,GAAqB,IAArB;AACA,qBAAK5B,aAAL,GAAqBuB,MAArB;AACH;AACJ;;AAED,YAAIM,UAAU,KAAKxB,IAAL,CAAUM,YAAV,CAAuBlC,GAAGqD,SAA1B,CAAd;AACAD,gBAAQE,IAAR,CAAa,QAAb;AACH,KAtFI;AAuFLC,cAvFK,wBAuFQ;AACT,YAAIN,aAAa,KAAK1B,aAAL,CAAmBW,YAAnB,CAAgC,WAAhC,EAA6Ce,UAA9D;AACA,YAAIA,cAAc,CAAlB,EAAqB;AACjBjD,eAAGiC,IAAH,CAAQ,QAAR,EAAkBuB,QAAlB,CAA2B,KAAKjC,aAAhC;AACH,SAFD,MAGK,IAAI0B,cAAc,CAAlB,EAAqB;AACtB,gBAAIC,SAAS,KAAK3B,aAAL,CAAmBW,YAAnB,CAAgC,WAAhC,EAA6CgB,MAA1D;AACAA,mBAAOM,QAAP,CAAgB,KAAKjC,aAArB;AACH;AACJ,KAhGI;AAiGLkC,gBAjGK,wBAiGQC,OAjGR,EAiGiB;;AAElB,YAAI,KAAKnD,SAAL,IAAkB,CAAC,CAAvB,EAA0B;AACtB,gBAAIoD,aAAaD,QAAQxB,YAAR,CAAqB,YAArB,CAAjB;AACAyB,uBAAWC,OAAX,CAAmB,KAAKvD,IAAxB,EAA6B,KAAKI,QAAlC;AACH,SAHD,MAIK;AACD,gBAAIoD,kBAAkB,EAAtB;AACA,iBAAK,IAAItB,KAAT,IAAkB,KAAK7B,QAAvB,EAAiC;AAC7B,oBAAI8B,aAAa,KAAK9B,QAAL,CAAc6B,KAAd,CAAjB;AACA,oBAAIC,cAAckB,OAAlB,EAA2B;AACvBG,oCAAgBC,IAAhB,CAAqBtB,UAArB;AACH,iBAFD,MAGK;AACD,wBAAIxC,GAAGsB,EAAH,CAAMoC,QAAQhB,CAAR,GAAYF,WAAWE,CAA7B,EAAgCgB,QAAQf,CAAR,GAAYH,WAAWG,CAAvD,EAA0DC,GAA1D,IAAiE,KAAKrC,SAA1E,EAAqF;AACjFsD,wCAAgBC,IAAhB,CAAqBtB,UAArB;AACH;AACJ;AACJ;;AAED,gBAAIqB,gBAAgBvB,MAAhB,GAAyB,CAA7B,EAAgC;AAC5B,qBAAK,IAAIC,KAAT,IAAkBsB,eAAlB,EAAmC;AAC/B,wBAAIrB,aAAaqB,gBAAgBtB,KAAhB,CAAjB;AACA,wBAAIoB,aAAanB,WAAWN,YAAX,CAAwB,YAAxB,CAAjB;AACAyB,+BAAWC,OAAX,CAAmB,KAAKvD,IAAxB,EAA6B,KAAKI,QAAlC;AACH;AACJ;AACJ;AACJ,KA7HI;AA+HLsB,cA/HK,sBA+HMgC,KA/HN,EA+Ha;AACd,YAAI,KAAKvC,UAAL,IAAmB,KAAvB,EAA8B;AAC1B,iBAAKwC,WAAL;AACH;AACDD,cAAME,eAAN;AACH,KApII;AAsILC,aAtIK,uBAsIO;AACR,aAAKtC,IAAL,CAAUC,cAAV,CAAyB,WAAzB,EAAsCsC,GAAtC,CAA0C,UAA1C,EAAqD,KAAKpC,UAA1D,EAAqE,IAArE;AACH,KAxII;AA0ILiC,eA1IK,yBA0IQ;AACT,YAAII,KAAKpE,GAAG+C,WAAH,CAAe,KAAKrB,aAApB,CAAT;AACA,aAAKD,SAAL,GAAiB2C,EAAjB;AACAA,WAAGC,KAAH,GAAW,CAAX;AACAD,WAAG1B,CAAH,GAAO,CAAP;AACA0B,WAAGzB,CAAH,GAAO,MAAP;AACA,aAAKnB,UAAL,GAAkB,IAAlB;AACA,aAAKI,IAAL,CAAU4B,QAAV,CAAmBY,EAAnB;AACApE,WAAGsE,KAAH,CAASF,EAAT,EACKG,EADL,CACQ,GADR,EACY,EAACF,OAAO,GAAR,EADZ,EAEKrC,KAFL;AAGH,KArJI;AAuJLwC,iBAvJK,2BAuJW;AACZ,YAAI,KAAKhD,UAAL,IAAmB,IAAvB,EAA6B;AACzB,gBAAIR,OAAO,IAAX;AACAhB,eAAGsE,KAAH,CAAS,KAAK7C,SAAd,EACK8C,EADL,CACQ,GADR,EACY,EAACF,OAAO,CAAR,EADZ,EAEKI,IAFL,CAEU,YAAU;AACZzD,qBAAKS,SAAL,CAAeiD,gBAAf;AACA1D,qBAAKS,SAAL,GAAiB,IAAjB;AACAT,qBAAKQ,UAAL,GAAkB,KAAlB;AACH,aANL,EAOKQ,KAPL;AAQH;AACJ;AAnKI,CAAT","file":"towerMgr.js","sourceRoot":"../../../../../../assets/scripts/towerDefens/towers","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] https://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        hurt: 10,\n        hurtDelta: 1, // mesured by second\n        hurtRange: -1, // -1 indicate that the tower will attack only one enmy\n        attackRange: 1000,\n        hurtType: 1, //1 indicate physical, 2 indicate magical\n        monstors: null,\n        canAttack: {\n            get() {\n                if (this._canAttack == null) {\n                    this._canAttack = true\n                }\n                return this._canAttack\n            },\n            set(value) {\n                this._canAttack = value\n                if (value == false) {\n                    var self = this\n                    this.scheduleOnce(function(){\n                        self._canAttack = true\n                    },this.hurtDelta)\n                }\n            }\n        },\n        bulletEffectPrefab: cc.Prefab,\n        hurtEffectPrefab: cc.Prefab,\n        bulletEffectOffset: cc.v2(0,0),\n        currentEffect: null,   \n        isUIShowed: false,\n        currentUI: null,\n        towerUIPrefab: cc.Prefab\n    },\n\n    // LIFE-CYCLE CALLBACKS:\n\n    onLoad () {\n        this.node.getChildByName(\"touchNode\").on(\"touchend\",this.onTouchEnd,this)\n    },\n\n    start () {\n        this.monstors = cc.find(\"Canvas/gameMgrNode\").getComponent(\"gameMgr\").alivedMonstors\n    },\n\n    update (dt) {\n        if (this.canAttack == true && this.monstors.length > 0) {\n            for (var index in this.monstors) {\n                var oneMonstor = this.monstors[index]\n                var dis = cc.v2(oneMonstor.x - this.node.x, oneMonstor.y - this.node.y).mag()\n                if (dis <= this.attackRange) {\n                    this.attackOneMonstor(oneMonstor)\n                    break\n                }\n            }\n        }\n    },\n\n    attackOneMonstor(oneMonstor) {\n        this.canAttack = false\n        if (this.bulletEffectPrefab != null) {\n            var effect = cc.instantiate(this.bulletEffectPrefab)\n            effect.x = this.node.x + this.bulletEffectOffset.x\n            effect.y = this.node.y + this.bulletEffectOffset.y\n            var effectMgr = effect.getComponent(\"effectMgr\")\n            effectMgr.effectType = 1\n            if (this.hurtEffectPrefab != null) {\n                effectMgr.hurtEffectPrefab = this.hurtEffectPrefab\n            }  \n            effectMgr.target = oneMonstor\n            effectMgr.delegate = this\n            this.currentEffect = effect\n        }\n        else {\n            if (this.hurtEffectPrefab != null) {\n                var effect = cc.instantiate(this.hurtEffectPrefab)\n                var effectMgr = effect.getComponent(\"effectMgr\")\n                effectMgr.effectType = 2\n                effectMgr.delegate = this\n                this.currentEffect = effect\n            }\n        }\n    \n        var animate = this.node.getComponent(cc.Animation)\n        animate.play(\"attack\")\n    },\n    playEffect() {\n        var effectType = this.currentEffect.getComponent(\"effectMgr\").effectType\n        if (effectType == 1) {\n            cc.find(\"Canvas\").addChild(this.currentEffect)\n        }\n        else if (effectType == 2) {\n            var target = this.currentEffect.getComponent(\"effectMgr\").target\n            target.addChild(this.currentEffect)\n        }\n    },\n    _acturalHurt(monstor) {\n\n        if (this.hurtRange == -1) {\n            var monstorMgr = monstor.getComponent(\"monstorMgr\")\n            monstorMgr.getHurt(this.hurt,this.hurtType)\n        }\n        else {\n            var monstorsForHurt = []\n            for (var index in this.monstors) {\n                var oneMonstor = this.monstors[index]\n                if (oneMonstor == monstor) {\n                    monstorsForHurt.push(oneMonstor)\n                }\n                else {\n                    if (cc.v2(monstor.x - oneMonstor.x, monstor.y - oneMonstor.y).mag <= this.hurtRange) {\n                        monstorsForHurt.push(oneMonstor)\n                    }\n                }\n            }\n           \n            if (monstorsForHurt.length > 0) {\n                for (var index in monstorsForHurt) {\n                    var oneMonstor = monstorsForHurt[index]\n                    var monstorMgr = oneMonstor.getComponent(\"monstorMgr\")\n                    monstorMgr.getHurt(this.hurt,this.hurtType)\n                }\n            }\n        }\n    },\n\n    onTouchEnd(event) {\n        if (this.isUIShowed == false) {\n            this.showTowerUI()\n        }\n        event.stopPropagation()\n    },\n\n    onDestroy() {\n        this.node.getChildByName(\"touchNode\").off(\"touchend\",this.onTouchEnd,this)\n    },\n\n    showTowerUI(){\n        var ui = cc.instantiate(this.towerUIPrefab)\n        this.currentUI = ui\n        ui.scale = 0\n        ui.x = 0\n        ui.y = 26.333\n        this.isUIShowed = true\n        this.node.addChild(ui)\n        cc.tween(ui)\n            .to(0.2,{scale: 1.2})\n            .start()\n    },\n\n    removeTowerUI() {\n        if (this.isUIShowed == true) {\n            var self = this\n            cc.tween(this.currentUI)\n                .to(0.2,{scale: 0})\n                .call(function(){\n                    self.currentUI.removeFromParent()\n                    self.currentUI = null\n                    self.isUIShowed = false\n                })\n                .start()\n        }\n    },\n    \n\n    \n});\n"]}